% fsp = face-related factor of C latency in easy tasks
% facc = face-related factor of C latency in difficult tasks 

%% Preparing data & preprocessing of data
clear all; clc;

% add eeglab path 
cd \\daten.w2kroot.uni-oldenburg.de\home\kafu3624\Desktop\Practical_Project % change directory
addpath(genpath('\\daten.w2kroot.uni-oldenburg.de\home\kafu3624\Desktop\Practical_Project')) % add directory with all subfolders to the path
eeglabpath = fileparts(which('eeglab.m')); % create variable storing a path to eeglab toolbox
eeglab;

% DEFINE FOLDERS

path_facedata = 'Y:\face'; % where face data is located
path_housedata = 'Y:\house'; % where house data is located
mainpath = 'Y:\Rosina'; % main path
path_preprocessed = [mainpath, '\PreprocessedData']; % where pre-processed data is saved

% CREATE INDIVIDUAL FOLDERS FOR FORKING PATHS

% Create individual folders where data processed with -100 ms baseline is to be saved:
cd(path_preprocessed)
mkdir('average_reference');
mkdir('mastoid_reference');
mkdir('REST_reference');
mkdir('CSD_reference');


% Create  list of files
cd(path_facedata)
files_face = dir('**/*.set');

cd(path_housedata)
files_house = dir('**/*.set'); %% DONT FORGET HOUSE DATA
%% offline rereference preprocessed data to 4 different reference schemes
for eeg_file = 1:length(files_face)
    
    cd(eeglabpath); 
    close all; clc; 
    eeglab; % start eeglab (and restart it after every iteration of the loop)

    % Import data:
    EEG = pop_loadset(files_face(eeg_file).name);
    EEG2 = EEG;
    EEG3 = EEG;
    EEG4 = EEG;

    % save data in average_reference folder, because at the moment common-average is reference 
    EEG = pop_editset(EEG, 'setname', sprintf('CAR_%s',EEG.setname));
    EEG = pop_saveset(EEG, 'filename', EEG.setname, 'filepath', 'Y:\Rosina\PreprocessedData\average_reference\');

    % re-reference to linked mastoid & save
    % do I need to interpolate?? A1 & A2 wont be relevant for analysis-->no
    EEG2 = pop_reref(EEG2, [40 41]) %A1 and A2 are mastoids
    EEG2 = pop_editset(EEG2, 'setname', sprintf('LM_%s',EEG2.setname));
    EEG2 = pop_saveset(EEG2, 'filename', EEG2.setname, 'filepath', 'Y:\Rosina\PreprocessedData\mastoid_reference\');

    % re-reference to REST reference & save
    % download REST extension for eeglab
    % https://www.neuro.uestc.edu.cn/name/shopwap/do/index/content/96
    %pop_REST_reref(EEG3)
    % oder rest_reref() 
    EEG3=ref_infinity(EEG3);
    EEG3.ref = 'REST';
    EEG3 = pop_editset(EEG3, 'setname', sprintf('REST_%s',EEG3.setname));
    EEG3 = pop_saveset(EEG3, 'filename', EEG3.setname, 'filepath', 'Y:\Rosina\PreprocessedData\REST_reference\');
    
    

    % re-reference to current source density
    % https://psychophysiology.cpmc.columbia.edu/software/CSDtoolbox/tutorial.html
    % https://www.frontiersin.org/articles/10.3389/fnins.2021.660449/full#footnote3
    % https://osf.io/m4vfu
    %MikeCohen writes in his book that a minimum of 64 electrodes should be
    %there???
    cd Y:\Rosina
	EEG4.data=laplacian_perrinX(EEG4.data, [EEG4.chanlocs.X],[EEG4.chanlocs.Y],[EEG4.chanlocs.Z]);
    EEG4.ref = 'CSD';
    EEG4 = pop_editset(EEG4, 'setname', sprintf('CSD_%s',EEG4.setname));
    EEG4 = pop_saveset(EEG4, 'filename', EEG4.setname, 'filepath', 'Y:\Rosina\PreprocessedData\CSD_reference\');
    

end

%% Tryout if rereferencing yielded in a difference in plotting
x=[-200:1999];
figure;
hold on;
for i=1:34
plot(x, EEG.data(2,:,i), 'r')
end
for i=1:34
plot(x, EEG2.data(2,:,i), 'b')
end
for i=1:34
plot(x, EEG3.data(2,:,i), 'g')
end
for i=1:34
plot(x, EEG4.data(2,:,i), 'y')
end
%% Preparation for Second multiverse step: 4 electrode groups
% (1) Cz, CPz,Pz; (2) Pz, Fz, Cz; (3) Cz; (4 )Pz
channels_group1 = [18, 28];
channels_group2 = [8, 18, 28];
channels_group3 = 18;
channels_group4 = 28; 
channels = {channels_group1, channels_group2, channels_group3, channels_group4};

% save all 4 different EEG files in one cell
allEEG={EEG;EEG2; EEG3;EEG4}

%create in each reference folder 4 different folders for each electrode group that we want to investigate 
average_path ='Y:\Rosina\PreprocessedData\average_reference';
cdf_path = 'Y:\Rosina\PreprocessedData\cdf_reference';
mastoid_path ='Y:\Rosina\PreprocessedData\mastoid_reference';
REST_path = 'Y:\Rosina\PreprocessedData\REST_reference';
folders = {average_path; cdf_path; mastoid_path; REST_path}
% loop to create folders
for i = 1 : 4
    for j = 1:4
    foldername = fullfile(folders{i}, sprintf('elec_group_%d', j));
    mkdir(foldername)
    end
end

%% 2nd Multiverse step: Select certain electrodes (see above)
% loop to run through all folders and subfolders
for i = 1:4 %folders refernce method
    for j=1:4 % subfolders electrode groups
    % go to each subfolder
    cd(fullfile(folders{i}, sprintf('elec_group_%d', j)));
    EEG_temp=allEEG{i}; % create temporary EEG
    EEG_temp.data = allEEG{i}.data(channels{j},:,:); % select channels of interes
    EEG_temp = pop_editset(EEG_temp, 'setname', [sprintf('elec_group_%d_', j), EEG_temp.setname]); %edit setname
    EEG_temp = pop_saveset(EEG_temp, 'filename', EEG_temp.setname, 'filepath', fullfile(folders{i}, sprintf('elec_group_%d', j))); % save with new name
    
    end
end

